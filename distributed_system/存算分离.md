# 存算分离


## 趋势


### 网络改善


硬件：


- Basic/Foundational NIC
    - Usually 1Gbps – 25Gbps
    - Relies on CPU for protocol processing – ≥ 30% server

- Smart NIC
    - ≥ 50Gbps
    - Offload network protocol processing
    - Have their own processor, memory & OS

- DPU
    - Smart NIC + security + storage
    - Custom chips and/or FPGAs  

T. Döring et al., SmartNICs: Current Trends in Research and Industry, 2020
https://www.net.in.tum.de/fileadmin/TUM/NET/NET-2021-05-1/NET-2021-05-1_05.pdf

软件：

- High overhead of TCP
    - 100+ GB
- Low-overhead protocol
    - RDMA (Infiniband, RoCE)
    - CXL(Compute Express Link)
- Efficient RPC protocol – higher level
    - ack ？ udp协议？


RDMA
- Copies data from application memory to NIC
- Copies data across the network
- Requires handling of cache coherence (in some configurations)
- Requires a CPU/controller at memory nodes

CXL
- Does not copy data into NIC buffers
- Does not copy data across the network, accesses remote memory
- Provides a hardware supported coherent cache
- No need for CPU/controller at memory nodes


8x RDMA


1 L. Barroso, et al. Attack of the Killer Microseconds. Commun. ACM, 2017.
2 J. Ousterhout. It’s Time to Replace TCP in the Datacenter, arXiv 2210.00714, 2023.
D. Gouk, et al. Direct Access, High Performance Memory Disaggregation with DirectCXL. Proc. USENIX ATC, 2022.



#### REF

- Disaggregated & Heterogeneous Platform for Data Management . cs848-w2024

## 问题

### shared-nothing架构下的LSM-based 数据库

- 不同分片数据不均衡，某些热点数据处理压力大
- 后台进行flush/compaction或者数据迁移时产生的抖动
- 内存是昂贵的开销
    - DRAM is an expensive resource in the cloud – 50% of server cost on Azure
    - Memory utilization is low in the (current) cloud


### 存算分离优势


- 性能提升
    - 独立,弹性扩展：存算分离允许计算资源和存储资源独立扩展，这意味着可以根据业务需求单独增加计算能力或存储容量，从而优化整体性能。
    - 资源利用率高：计算和存储任务被分配给专门设计的资源池，计算池专注于处理查询，存储池专注于高效数据存储（内存池）
- 可靠性增强    
    - 数据高可用：在存算分离架构中，数据存储在高可靠的专业存储系统中，即使计算节点故障，数据依然安全，确保业务连续性。
    - 故障容忍：高端存储系统设计有高故障容忍能力，减少硬件冗余需求，提升整体可靠性。
    - 计算节点快速恢复、扩展：无需恢复数据
- 降低成本：通过灵活扩展计算和存储资源，可以降低系统的整体成本

### 存算分离难点

- 网络延迟：计算节点和存储节点之间的通信需要通过网络进行，网络状况直接影响写入、查询响应速度
    - 缓存、压缩
    - 近数计算  near-data computing， log-as-the-database

- 资源共享
    - 分布式共享存储、共享内存的可以被计算节点使用（内存的一致性、并发控制）
    - 弹性扩展


## 实现

### OLTP

- Amazon Aurora
- Microsoft Socrates
- Google AlloyDB
- Alibaba PolarDB


### OLAP

- Snowflake
    - 存储层
        - 基于S3的高可用和持久行
            - 慢，但是廉价和可用
            - 计算节点依赖缓存
        - Partition table into file
            - 文件大小 16MB
        - PAX hybrid columnar storage format
        - 所有计算节点可以访问所有存储数据
    - 计算层
        - Virtual Warehouse (VW)，MPP
        - Elasticity
    - 控制层
        - 元信息，计划，访问控制
- Amazon Redshift


## REF

### 学术
- [cs848-w2024](https://ozsu.github.io/cs848-w2024/Schedule.html) slides 推荐

- [SIGMOD23_DisaggregatedDB_Slides](https://www.cs.purdue.edu/homes/csjgwang/pubs/SIGMOD23_DisaggregatedDB_Slides.pdf)
    - [papaer](https://www.cs.purdue.edu/homes/csjgwang/pubs/SIGMOD23_Tutorial_DisaggregatedDB.pdf)

- [ASPLOS2020 Hailstorm: Disaggregated Compute and Storage for Distributed LSM-based Databases 笔记](https://zhuanlan.zhihu.com/p/381280016)



### 实践

- [ClickHouse 存算分离架构探索](https://zhuanlan.zhihu.com/p/357451583) 

- [全新存算分离架构——[SIGMOD2021] PolarDB Serverless: A Cloud Native Database for Disaggregated Data Centers 笔记](https://zhuanlan.zhihu.com/p/382109937)

- [存算分离/DB on K8s 论文/blog收集](https://zhuanlan.zhihu.com/p/377755864)

- [存算分离下写性能提升10倍以上，EMR Spark引擎是如何做到的？](https://zhuanlan.zhihu.com/p/272202352) 

