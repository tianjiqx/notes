# 事务

分布式一致性问题相关解决技术

- 2pc，3pc，解决分布式事务一致性
- raft，paxos，解决多副本数据一致性

## 分布式事务

### 1. 2PC&3PC

#### 1.1 两阶段提交协议2PC

保障分布式环境下，跨节点事务的ACID性。

节点：

- 协调者：一个
- 参与者：多个

执行过程：

- 准备（投票）阶段： 协调者询问参与者事务是否执行成功；  
- 提交阶段： 如果事务在每个参与者上都执行成功， 协调者发送通知让参与者提交事务； 否则， 协调者发送通知让参与者回滚事务。  

问题：

网络通信阻塞、单点故障，部分提交。**（归纳问题出现原因，1.节点挂掉，不同功能节点挂掉影响。2.网络通信问题，脑裂影响）**

- 参与者故障，准备，提交阶段的协调者，一直等待。（网络通信阻塞）
  - 解决方法：设置事务超时时间，参与者不响应，认为事务执行失败，abort
- 协调者故障，发生在提交阶段，参与者一直阻塞，等待协调者的commit/abort
  - 引入备协调者？，操作日志同步
  - 重新选举协调者，参与者，超时，用类似raft任期？
- 数据不一致。提交阶段，调者向参与者发送commit，然后发生局部网络异常，导致只有一部分参与者接受到commit。
  - **互询机制**，向其他参与者，获取事务是否可以提交



#### 1.2 三阶段提交3PC

在2PC基础上，引入一个 **预提交** 阶段，以及**超时策略**来减少整个集群的阻塞时间，提升系统性能。“非阻塞”协议。

> 预提交阶段：解决原先在两阶段提交中，参与者在投票之后，由于协调者发生崩溃或错误，而导致参与者处于无法知晓是否提交或者中止的“不确定状态”所产生的可能相当长的延时的问题。

执行过程：

- 第一阶段，准备（询问）阶段CanComint，询问各个参与者是否能够正常执行事务（未执行），参与者回复。
  - 不执行事务，减少资源锁定
- 第二阶段，预提交PreCommit，根据第一阶段回复结果，协调者发送pre_commit/abort给参与者，是cam_commit参与者执行事务，但不提交。参与者发ack。
  - 统一状态，知道所有参与者都在pre_commit阶段了，而2PC不知道其他节点是否在准备阶段
- 第三阶段，提交阶段doCommit，所有参与者都完成正常执行事务后，协调者发送提交通知，参与者提交事务。否则回滚事务。

解决的问题：

- 单点故障。协调者在第三阶段无响应时，收到pre_commit的参与者超时，自动提交。

仍然存在的问题：

- 数据不一致。部分节点在pre_commit阶段失败，协调者需要回滚，但是网络问题，导致超时提交的节点，提交而未回滚。



2PC到3PC的启示：

所有计算机软件问题，都可以通过再引入一个中间层，来解决问题。

类似，降维思想。



### TCC（Try-Confirm-Cancel）



### REF

- [分布式事务：两阶段提交与三阶段提交](https://segmentfault.com/a/1190000012534071) 更加详细的2阶段实现过程
- [三阶段提交-wiki](https://zh.wikipedia.org/wiki/%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4)
- [分布式一致性之两阶段提交协议、三阶提交协议](https://zhuanlan.zhihu.com/p/35616810)
- [分布式事务，这一篇就够了-小米信息部技术团队-李文华](https://xiaomi-info.github.io/2020/01/02/distributed-transaction/)













