# AI meets DataBase：AI4DB and DB4AI 笔记

[TOC]

## 1. 背景

- 数据库的广泛使用
  - 提供用户友好的声明式查询范式和封装复杂的查询优化
- 人工智能的突破
  - 驱动力：海量数据、新算法和高计算能力



- 数据库和人工智能 (AI) 可以相互受益
  - 人工智能可以让数据库更智能（AI4DB）
    - 改进传统的数据库优化技术（基于经验的方法和规范，需要人工参与，大规模集群、多样的应用负载需求，尤其是云）
      - 代价估算
      - join重排序
      - 参数调优
      - 索引、视图创建推荐
    - 监控、安全方面
  - 数据库技术可以优化人工智能模型（DB4AI）
    - 数据治理，提高数据质量
      - 数据发现、数据清洗、数据集成、数据标记和数据沿袭
    - 降低使用人工智能模型的复杂性
      - 面向 AI 的声明性语言
        - 自动选择合适的模型，推荐模型参数
      - 加速训练、推理



## 2. AI for DB

（不要为了AI而AI，应该看AI的什么技术能够解决传统数据库的旧问题和新环境下的新问题）

### 2.1 基于学习的数据库配置

利用机器学习技术（强化学习，基于环境而行动，获取最大化的预期收益，不需要监督学习的标签，也不对非最优解进行纠正，也叫近似动态规划）来自动化数据库配置。

- Knob（旋钮） tuning：自动数据库配置

  - 数据库上百的配置
    - 云数据库上的数百万个数据库实例，无法一一调整
  - 基于学习
    - 更高，更快的自动配置调整
    - CDBTune
      - 将数据库调优建模为一个顺序决策问题，并依靠强化学习来提高调优性能
    - QTune
      - 进一步表征查询特征，实现更细粒度的调优，例如查询级调优、会话级调优和系统级调优。

- 索引建议

  - 基于强化学习
    - Z. Sadri, L. Gruenwald, and E. Leal. Online index selection using deep reinforce- ment learning for a cluster database. In ICDE, pages 158–161, 2020
      - 将工作负载特征表示为查询的到达率，列特征表示为每列的访问频率和选择性
        - the arrival rate of queries？TODO
      - 使用马尔可夫决策过程模型 (MDP)
        - 学习的特征：查询，列，输出（创建/删除索引）

- (物化)视图建议

  - 自动识别给定查询工作负载的适当的物化视图

- 分区

  - 选择适合的分区键

  

### 2.2 基于学习的数据库优化

利用机器学习技术来解决数据库优化中的难题。

- SQL 重写
  - SQL重写的规则，和应用规则顺序，重复应用
- 代价/基数估计
  - 传统问题：
    - 不同列/表之间的相关性
    - 数据倾斜
  - 基于深度学习的技术
    - CNN，RNN，混合模型
      - 使用深度神经网络捕获数据相关性来估计成本和基数
- 连接顺序选择
  - 传统
    - 数量上10后，使用启发式规则
  - 基于学习
    - SkinnerDB基于蒙特卡罗树搜索的方法在每个时间片中尝试不同的连接顺序
- 端到端的优化器
  - 完整的优化，考虑索引和物化视图
  - 使用延迟latency作为反馈（TODO：计划执行一遍的时间？应该不是这样吧）

### 2.3  基于学习的数据库设计

利用机器学习技术来设计数据库组件：

- 索引
  -  B+树索引可以看作是将每个查询键映射到其页面的模型，用训练好的模型代替现有B+树索引
    - 减少索引大小，提高使用索引的查询性能
- KV 存储设计
  - 为场景（硬件，读写事务）设计适合的数据结构（模型）
    - 基本设计组件
      - fence pointers, links, and temporal partitioning
- 事务管理
  - 通过有效的工作负载调度，避免数据冲突来，来提高性能
    - 事务预测
      - 预测负载趋势
    - 事务调度
      - 传统：顺序/执行成本
      - 学习：平衡并发和冲突率
        - buffer state

### 2.4 基于学习的数据库监控

基于机器学习的技术来监控数据库活动并报告异常，传统DBA监控，不完整和低效：

- 健康监测
  - 健康指标（现有系统这些指标都已经存在）
    - 每秒查询次数
    - 查询延迟
    - CPU 使用率
    - 每秒事务数
  - 通过对关键性能指标KPI 聚类，异常情况通知DBA
- 活动监测
  - 活动
    - 创建新帐户、查看敏感信息
  - 活动风险评估
- 性能预测
  - 用来满足服务级别协议 (SLA) ，尤其并发查询时
    - 分析慢SQL的根本原因

### 2.5 基于学习的数据库安全性

传统的数据库安全技术（例如数据屏蔽和审计、敏感数据发现）依赖于用户定义的规则，无法自动检测未知的安全漏洞。

基于学习的算法来发现敏感数据、检测异常、进行访问控制并避免 SQL 注入。

- 敏感数据发现
- 访问控制
  - 表级和记录级访问控制
- SQL注入检测
  - 分类树
  - 模糊神经网络



AI4DB的实践：

- oracle
  - 自动化日常任务
  - 自动配置调优，安全，备份
- openGauss
  - 数据库调优、优化设计、诊断
- OtterTune
  - 自动调优服务



### 2.6 Autonomous Database Systems   自治数据库系统

动机：

- 传统数据库设计费力
  - 基于工作负载/数据特征开发数据库（OLTP，OLAP，HTAP）
  - 某些通用模块可能无法在所有情况下都能正常工作
- 大多数 AI4DB 作品专注于单个模块
  - 很高的训练开销，得到的也只是局部最优
- AI4DB作品没有商业实践
  - 重 ML 模型很难在内核中实现
  - 需要统一的训练平台



- Peloton
  - Andy Pavlo, and et al. Self-Driving Database Management Systems. In CIDR, 2017.  
  - 无需人工干预即可自动运行
    - 嵌入式监控器：检测事件流
    - 工作负载预测模型：预测未来工作负载类型
    - 优化动作：调优、规划

- SageDB
  - Tim Kraska, and et al. SageDB: A Learned Database System. In CIDR, 2019.  
  - 通过学习数据分布来专业化数据库实现的愿景
    - 通过学习的 CDF 学习数据分布
    - 设计学习索引和查询调度等组件
- openGauss
  - Guoliang Li, and et al. openGauss: An Autonomous Database System. In VLDB, 2021.  
  - 优化器学习模型
  - 建议模型
  - 模型验证



总结：

- AI只是工具，是解决棘手问题的重要工具
  - 高维回归
  - NP难题
-  需要 AI 用于许多不同的场景，尤其是在云上
  - 硬件配置
  - SLA 要求
  - 查询模式
- 目前AI4DB的工作重点是OLAP，数据很少更新，用户对训练延迟不敏感
  - 提升面向OLAP的大规模数据分析能力
  - 适应OLTP频繁的数据更新



## 3. DB for AI

### 3.1 声明式语言模型

传统的机器学习算法大多是用命令式的编程语言（Python、R）实现，具有局限：

- 需要工程技能来定义完整的执行逻辑
  - 模型训练的迭代模式， 如何运算
- 机器学习算法必须从数据库系统加载数据
  - 数据导入/导出成本



声明式语言，SQL，

优点：

- 可以直接在数据库中使用
- 使用简单

缺点：

- 缺乏一些复杂的处理模式
  - 迭代训练



解决方式：扩展SQL，以支持 AI 模型

> T. Schindler and C. Skornia. Secure parallel processing of big data using order- preserving encryption on google bigquery. CoRR, abs/1608.07981, 2016.



TODO: 对比 spark ML ？



### 3.2 数据治理

数据质量，大大影响训练效率，训练精度。

- 数据发现
  - 考虑应用程序和用户需求，从数据仓库中自动查找相关数据集
- 数据清洗
  - 清理框架 ActiveClean
- 数据标注
  - 存储标准好的训练数据
  - 众包

### 3.3 模型训练

加快模型训练速度：

- 特征选择
  - 批处理
  - 物化
    - 降低特征枚举成本
  - 主动学习
    - 加速评估过程
- 模型选择
  - 瓶颈：模型选择吞吐量，即每单位时间测试训练配置的数量
  - 并行技术加速
    - 任务并行
    - 批量同步并行
    - 参数服务器 （这个名字看到挺多的）
    - 模型并行
- 模型管理
  - 维护已经尝试过的模型和参数
  - 基于GUI，命令的模型管理系统
- 硬件加速
  - 数据库引入新硬件，加速机器学习算法
    - GPU
    - FPGA

### 3.4 模型推理

使用数据库内优化技术（例如算子Operator支持、算子选择、执行加速）有效地加速模型推断结果。

- AI算子支持
  - 标量，张量类型
  - SystemML
- 算子选择
  - 数据库内选择机器学习模型的物理算子
- 执行加速
  - 内存方法
    - 将数据压缩到内存中并尽可能多地进行内存计算
    - （这种好像是AI领域主流，避免分布式节点通信，类似超算MPI架构）
  - 分布式方法
    - 将任务路由到不同的节点，使用并行计算减少数据处理和模型计算的负担



## 4. 挑战和开放性问题

AI4DB:

- 模型选择
  - ML模型（forward-feeding, sequential, graph embedding）选择，调参
  - 很难评估效果
- 模型验证
  - 如何评估学习的模型是否有效并优于非学习方法
- 模型管理
  - 不同的数据库组件可能使用不同的ML模型
  - 需要提供统一的ML平台以实现统一的资源调度和统一的模型管理
- 训练数据
  - 如何获取大规模、高质量、多样化的训练数据，进行训练
    - DBA 经验，场景，硬件环境，工作负载
- 适应性
  - 适应动态数据更新、其他数据集、新硬件环境和其他数据库系统
- 模型收敛
  - 训练能否收敛到一个最终结果
-  OLAP 学习
  - 处理图数据、时间序列数据、空间数据
  - 图像分析
- OLTP 学习
  - 事务建模和调度



DB4AI:

- 数据库内训练
  - 模型存储、模型更新和并行训练
    - 安全和隐私问题
    - 数据更新
- 使用数据库技术进行训练加速
  - 使用索引，物化视图等，只选择重要例子，加速训练效率
- 人工智能优化器
  - 支持AI算子的优化器，免将AI算子转换为数据库内部算子
- 容错学习
  - 提供训练时，容错（进程崩溃），灾难恢复能力



AI&DB协同优化：

- 支持混合关系模型和张量模型
  - CPU 无法高效处理张量模型
  - AI芯片无法高效处理关系模型
    - AI 芯片上的关系运算
- 混合 DB&AI 推理
  - 同时进行 DB 和 AI 操作
    - 查找住院时间超过 3 天的医院的所有患者
      - 原始方式：预测每个患者的住院时间，然后剪枝
      - 希望结合数据库，做AI算子下推等优化
- 混合DB&AI系统
  - 完整的支持声明式语言的端到端混合AI&DB系统
    - 针对2种需求的优化器，执行引擎，存储引擎



## REF

- [paper:AI Meets Database: AI4DB and DB4AI](https://dbgroup.cs.tsinghua.edu.cn/ligl/papers/sigmod21-tutorial-paper.pdf)
- [slides:AI4DB and DB4AI](http://dbgroup.cs.tsinghua.edu.cn/ligl/papers/sigmod21-tutorial-slides.pdf) 原理，细节更多
- [slides:AI Techniques for Database Management (AI4DB)](https://www.dbse.ovgu.de/-p-578-EGOTEC-1cqh22dl2nhj0u6n463gvmg9d4/_/5_ai-1.pdf)

- [vldb2021 tutorials 汇总（paper，slides）](https://vldb.org/2021/?program-schedule-tutorials)
- [wiki:强化学习](https://zh.wikipedia.org/wiki/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0)
- [强化学习-Reinforcement learning | RL](https://easyai.tech/ai-definition/reinforcement-learning/)

