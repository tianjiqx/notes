## 性能之巅：网络
（注意本文仅列出linux命令，原书Solaris系统不予显示）
关注：网络延时，吞吐量，消除丢包引起的延时异常

网络分析：
- 硬件：网络接口卡，交换机，路由器和网关
- 软件：内核协议栈TCP/IP


### 术语：
- 接口：网路物理连接器（连接物理网卡的端口），网络端口的逻辑实例
- 数据包：IP级路由报文，对帧的封装，包长度受限最大传输单元MTU（ifconfig可查看网卡的MTU，一般1500B，巨帧9000B，[Linux下查看与修改mtu值](https://www.cnblogs.com/wjoyxt/p/6873714.html)）
- 帧：数据链路层，报文，如以太帧
- 带宽：网络最大传输速率，单位b/s。千M，万M网
- 吞吐量：两个网路端点的数据传输率，b/s或B/s
- 延时：一个报文往返端点时间，建立连接的时间，不包括后续数据传输时间。
主机名解析延时，ping 延时（网络跳转），连接延时（握手）。首字节延时（相对ping延时，目标服务器在tcp积压队列，CPU队列，导致的处理延时）
- 网络接口使用率：当前**吞吐量/最大带宽**，接近100%，则产生瓶颈
- 硬件：
 - 接口：  受限网卡速度
 - 控制器：受限I/O传输通道（如PCI）接入系统
 - 交换机：局域网内主机专用通信路径
 - 路由器：网络间传递数据包

- 软件：
 - 网络栈：TCP/IP
 - 网络设备驱动：内核与NIC通信，环形缓冲区
 

### 方法：

#### 1. 工具法
遍历工具，提供关键指标
- netstat -s ：查找高流量的重新传输和乱序数据包。
- netstat -i ：检查接口的错误计数器。
- ifconfig ：检查错误，丢弃，超限。
- 吞吐量：RX、TX，B/s
- tcpdump/snoop ：
- dtrace/tap/perf ：检查内核状态在内的

#### 2. USE方法 ？
- 使用率：接口发送（TX），接受（RX）帧时间
- 饱和度：额外的队列，缓存阻塞程度。
- 错误：CRC错误，帧过长过短，冲突


#### 3.工作负载特征归纳
平均数据包大小？RX、TX
协议？TCP，UDP
活跃的TCP/UDP端口？B/s、每秒连接数
使用网络的进程？
- 网络接口吞吐量：RX、TX，B/s
- 网络接口IOPS：RX、TX，帧每秒？
- TCP连接率：主动、被动，每秒连接数


#### 4.延时分析
TODO：网络延时

#### 5.性能检测
指标：
- 吞吐量：网络接口接受和传输的每秒字节数，每个接口
- 连接数：TCP每秒连接数
- 错误：丢包计数器
- TCP重传输
- TCP乱序数据包

云计算环境，应用限额收集。

#### 6.数据包嗅探
tcpdump工具
输出，每个数据包的总结，IP，TCP端口，TCP包头。由于数据包速率过高，被内核丢弃未传给tcpdump的包数量。

#### 7. TCP分析
- TCP 发送接受缓冲
- TCP积压队列
- 积压队列满导致的内核丢包
- 阻塞窗口大小、零长度通知
- TCP TIME-WAIT间隔中收到的SYN


#### 8.挖掘分析
挖掘数据包直到网络接口驱动
- 网络可调参数
- 内核网络特性是否生效
- 解释内核丢包


#### 9.静态性能调优
- 可供使用的网络接口，当前使用？
- 网络接口最大速度？
- 半双工，全双工？
- MTU值？
- 网络接口是否使用[链路聚合](https://www.cnblogs.com/641055499-mozai/p/11662401.html)？
- 可调参数？IP层，TCP层？
- 已经非默认值参数？
- 路由配置？默认路由
- 网络路径中网络组件的最大吞吐？
- 数据转发是否启用？
- DNS设置？距离服务器多远
- 网络驱动是否有已知bug？TCP/IP内核栈?
- 是否存在其他软件控制网络吞吐？云计算环境？



#### 10.资源控制
操作系统对网络资源的限制
- 网络带宽限制：内核针对不同协议，应用程序，允许的最大带宽
- IP服务品质：IP报文头中业务优先级

#### 11.微基准测试
网络环境。
- 方向：发送或接受
- 协议：TCP、UDP，端口
- 线程数
高速网络，可能需要各个客户线程驱动大最大带宽
- 缓冲长度
- 接口MTU长度

工具iperf


### 分析：
- netstat：多种网络栈和接口统计信息
- sar：统计信息历史
- ifconfig：接口配置
- ip：网络接口统计信息
- nicstat：网络接口吞吐量和使用率 （Solaris）
- ping：测试网络连通性
- traceroute：测试网络路由
- pathchar：确定网路路径特征
- tcpdump：网络数据包嗅探器
- Wireshark：图形化网络数据包检查器
- DTrace,perf：TCP/IP栈跟踪：连接，数据包，丢包，延时

#### 1. netstat （累计统计信息）
- 默认：列出连接的套接字
- -a：列出所有套接字信息
- -s：网络栈统计信息
- -i：网络接口信息
- -r：列出路由表

常用命令：
- `netstat -i`：列出各个接口信息统计（接口名，MTU，RX-和TX-指标）
  - OK：成功专属的数据表
  - ERR：错误数据包
  - DRP：丢包
  - OVR：超限
丢包和超限是网络接口饱和的指标。
netstat -ic: 每秒打印一次，显示累计计数器的变化。


- `netstat -s`：按协议（TCP，UDP，IP等）分组的网络栈统计信息。
 - IP：统计了接受和发送了多个个该协议的包，以及被丢弃的数量。
 - TCP：主动连接数，被动连接数，失败的连接尝试，已经建立的连接数，数据重传段的数目超过传输的段（网络是否不稳定的指标）
 - TcpExt：，套接字缓冲超限导致数据包冲接受队列中删除（网络饱和指标，增加套接字缓冲修复），快重传

同样支持 netstat -sc，连续打印。
`netstat -s 2` 间隔2s打印，后续处理计算速率
`netstat -s | grep connect` 查看tcp连接信息


#### 2.sar （间隔时间统计信息）
- -n DEV：网络接口统计信息
统计各个接口，接收和传输的数据包/s，千字节/s
- -n EDEV：网络接口错误
- -n IP：IP数据报统计信息
- -n EIP：IP错误统计信息
- -n TCP：TCP数据报统计信息
- -n ETCP：TCP错误统计信息
- -n SOCK：套接字使用

常用命令：
- `sar -n DEV`：
  - rxpkg/s（rxpck/s）：接收数据包, 数据包/s
  - txpkg/s：传输的数据包，数据包/s
  - rxkB/s：接收的千字节，千字节/s
  -  txkB/s：传输的千字节，千字节/s
  -  rxcmp/s：每秒发送的压缩包，数据包/s
  -   txcmp/s：每秒发送的压缩包，数据包/s
  -   rxmcst/s：每秒接收的多播压缩包，数据包/s

- ` sar -n DEV 1 |  awk 'NR == 3 || $2 == "eth0"   ' ` （英文时间格式 $3 == "eth0"）：显示eth0 接口的信息

- `sar -n SOCK`：
	- totsck：使用中的总数据包？
	- ip-frag：当前队列中的IP数据片
	- tcp-tw：TIME-WAIT中的TCP套接字

- `sar -n TCP 1`: 每秒打印的TCP统计信息
	- active/s：每秒主动连接率
	- passive/s：每秒被动连接率
	

统计信息中的方向和单位：
- rx：接收
- i：输入
- seg：段


#### 3. ifconfig
查看网卡状态，ip地址，以及手动配置网络接口。
- txqueuelen 发送队列长度

`ethtool eth0 | grep 'Speed|Duplex'` ：接口工作模式
`ethtool -S eth0 | grep crc` ：接口校验统计

#### 4.ip
格式化更好一点，也是累计统计信息。
常用命令：`ip -s link`

#### 5.ping
测试网络连通性，可记录每个包的往返时间rtt，以及跳转次数。

#### 6.traceroute
对ping的强化，跟踪路由过程，以及每一跳时间。命令：`traceroute <ip>`

#### 7.pathchar
对traceroute的强化，增加了没跳的带宽。但是未自带。
命令：`pathchar <ip>`


#### 8.tcpdump
常用命令：
- `tcpdump -i eth0 -w /tmp/out.tcpdump `：捕捉并检查网络数据包，Ctrl+C 终止。
- `tcpdump -enr /tmp/out.tcpdump -vvv -x`: -n 禁用解析hostname


#### 9.DTrace
TODO

#### 10.SystemTap
TODO

#### 11.perf
TODO








  















